version: '3'

volumes:
  elasticsearch-single-node:
  elasticsearch-node-1:
  elasticsearch-node-2:
  elasticsearch-node-3:
  s3:
  redis:
  amqp:


services:

  #####################
  ### Redis
  #####################

  redis:
    extends:
      file: templates/services.yml
      service: redis
    profiles:
      - demo
      - testing
    restart: always
    volumes:
      - redis:/data

  redis-dev:
    extends:
      file: templates/services.yml
      service: redis
    profiles:
      - development
    restart: unless-stopped
    ports:
      - 6379:6379


  #####################
  ### RabbitMQ
  #####################

  rabbitmq:
    extends:
      file: templates/services.yml
      service: rabbitmq
    profiles:
      - demo
      - testing
    restart: always
    volumes:
      - amqp:/var/lib/rabbitmq

  rabbitmq-dev:
    extends:
      file: templates/services.yml
      service: rabbitmq
    profiles:
      - development
    restart: unless-stopped
    ports:
      - 5672:5672
      - 15672:15672


  #####################
  ### MinIO
  #####################

  minio:
    extends:
      file: templates/services.yml
      service: minio
    profiles:
      - demo
      - testing
    command: server /data
    restart: always
    volumes:
      - s3:/data
    # ports:
    #   - "9000:9000" # FIXME

  minio-dev:
    extends:
      file: templates/services.yml
      service: minio
    profiles:
      - development
    command: server /data --console-address ":9001"
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9001:9001"


  #####################
  ### ElasticSearch
  #####################

  elasticsearch-single-node:
    extends:
      file: templates/services.yml
      service: elasticsearch-single-node
    profiles:
      - demo
    restart: always
    volumes:
      - elasticsearch-single-node:/usr/share/elasticsearch/data

  elasticsearch-node-1:
    extends:
      file: templates/services.yml
      service: elasticsearch-cluster-node
    profiles:
      - testing
    restart: always
    environment:
      - node.name=elasticsearch-node-1
      - discovery.seed_hosts=elasticsearch-node-2,elasticsearch-node-3
      - cluster.initial_master_nodes=elasticsearch-node-1,elasticsearch-node-2,elasticsearch-node-3
    volumes:
      - elasticsearch-node-1:/usr/share/elasticsearch/data

  elasticsearch-node-2:
    extends:
      file: templates/services.yml
      service: elasticsearch-cluster-node
    profiles:
      - testing
    restart: always
    environment:
      - node.name=elasticsearch-node-2
      - discovery.seed_hosts=elasticsearch-node-1,elasticsearch-node-3
      - cluster.initial_master_nodes=elasticsearch-node-1,elasticsearch-node-2,elasticsearch-node-3
    volumes:
      - elasticsearch-node-2:/usr/share/elasticsearch/data

  elasticsearch-node-3:
    extends:
      file: templates/services.yml
      service: elasticsearch-cluster-node
    profiles:
      - testing
    restart: always
    environment:
      - node.name=elasticsearch-node-3
      - discovery.seed_hosts=elasticsearch-node-1,elasticsearch-node-2
      - cluster.initial_master_nodes=elasticsearch-node-1,elasticsearch-node-2,elasticsearch-node-3
    volumes:
      - elasticsearch-node-3:/usr/share/elasticsearch/data

  elasticsearch-dev:
    extends:
      file: templates/services.yml
      service: elasticsearch-single-node
    profiles:
      - development
    restart: unless-stopped
    ports:
      - 9200:9200
      - 9300:9300


  #####################
  ### Kibana
  #####################

  kibana-dev:
    extends:
      file: templates/services.yml
      service: kibana
    profiles:
      - development
    restart: unless-stopped
    ports:
      - 5601:5601


  #####################
  ### OpenCTI Core
  #####################

  platform:
    extends:
      file: templates/opencti.yml
      service: platform
    profiles:
      - demo
      - testing
    restart: always
    ports:
      - "8080:8080"

  worker:
    extends:
      file: templates/opencti.yml
      service: worker
    profiles:
      - demo
      - testing
    restart: always
    deploy:
      mode: replicated
      replicas: 3


  #####################
  ### OpenCTI Connectors
  #####################

  connector-export-file-stix:
    extends:
      file: templates/opencti.yml
      service: connector-export-file-stix
    profiles:
      - demo
      - testing
    restart: always

  connector-export-file-csv:
    extends:
      file: templates/opencti.yml
      service: connector-export-file-csv
    profiles:
      - demo
      - testing
    restart: always

  connector-export-file-txt:
    extends:
      file: templates/opencti.yml
      service: connector-export-file-txt
    profiles:
      - demo
      - testing
    restart: always

  connector-import-file-stix:
    extends:
      file: templates/opencti.yml
      service: connector-import-file-stix
    profiles:
      - demo
      - testing
    restart: always

  connector-import-document:
    extends:
      file: templates/opencti.yml
      service: connector-import-document
    profiles:
      - demo
      - testing
    restart: always